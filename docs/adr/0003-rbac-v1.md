# ADR 0003: Ролевая модель RBAC v1

## Статус
Принято

## Контекст
Платформа объединяет заказчиков, исполнителей, модераторов и финансовую команду. До сих пор доступы проверялись точечно в вьюхах, что приводило к дублированию логики и сложностям с аудитом. Необходимо формализовать роли и закрепить матрицу прав, чтобы можно было централизованно проверять доступ в API и админских интерфейсах.

## Решение
Вводим явные роли уровня пользователя и профильные статусы:
- `guest` — неавторизованный посетитель;
- `user` — авторизованный пользователь без привязки к профилю;
- `freelancer` — пользователь с ролью исполнителя;
- `client` — пользователь с ролью заказчика;
- `verified` — пользователь, прошедший KYC/верификацию;
- `staff` — административный персонал (Django staff);
- `moderator` — модератор контента, отделённый от финансов;
- `finance` — сотрудники финансового контроля и платежей.

Политика доступа задаётся матрицей ролей × действий. Для краткости выделены ключевые доменные операции.

| Действие | guest | user | freelancer | client | verified | staff | moderator | finance |
| --- | --- | --- | --- | --- | --- | --- | --- | --- |
| Просмотр заказов | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ |
| Создание заказов | ❌ | ❌ | ❌ | ✅ | ✅* | ✅ | ❌ | ❌ |
| Редактирование/удаление своих заказов | ❌ | ❌ | ❌ | ✅ | ✅* | ✅ | ❌ | ❌ |
| Просмотр контрактов | ❌ | ❌ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ |
| Управление контрактом (подпись/закрытие) | ❌ | ❌ | ✅ | ✅ | ✅ | ✅ | ❌ | ✅ |
| Просмотр KYC | ❌ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ❌ |
| Модерация/аппрув KYC | ❌ | ❌ | ❌ | ❌ | ❌ | ✅ | ✅ | ❌ |
| Просмотр финансовых операций | ❌ | ❌ | ❌ | ❌ | ❌ | ✅ | ❌ | ✅ |
| Управление финансовыми операциями | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ | ✅ |

\*Для заказчиков требуется статус `verified`. Роль `staff` обходится без дополнительной верификации, а `finance` наследует права просмотра контрактов.

Реализовано центральное хранилище политик `accounts.rbac` и универсальный `RoleBasedAccessPermission`, который сопоставляет HTTP-метод или action DRF c требуемым действием и проверяет владение объектом через объектные гарды.

## Причины
- Централизованная проверка прав исключает дублирование логики в контроллерах.
- Матрица позволяет бизнесу быстро анализировать, кто что может делать, и расширять роли без переписывания всех вьюх.
- Объектные проверки гарантируют, что даже с аутентификацией пользователь не получит доступ к чужим сущностям.
- Разделение ролей модерации и финансов закрывает требование аудита и принципа наименьших привилегий.

## Последствия
- Любые новые эндпоинты должны описывать требуемое действие для RBAC, иначе доступ будет открыт всем по умолчанию.
- Для нестандартных сценариев понадобятся дополнительные object guard функции.
- Администраторам потребуется поддерживать группы `moderator` и `finance` в Django для назначения соответствующих ролей.
- Юнит-тесты должны покрывать типичные сценарии эскалации прав, чтобы гарантировать корректность политики при изменениях.

## Планы развития
- Поддержать конфигурацию ролей через панель администрирования, чтобы операторы могли добавлять временные роли без релиза кода.
- Добавить аудит решений RBAC и логирование отказов для расследований инцидентов.
- Интегрировать RBAC-политику с внешними инструментами IAM при масштабировании команды.
