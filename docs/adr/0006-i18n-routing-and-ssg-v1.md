# ADR 0006: I18n Routing and SSG Strategy v1

## Статус
Предложено (2024-06-14)

## Контекст
- Публичные страницы (лендинг, описание escrow, "как работает", витрина профилей и т.п.) сейчас отрисовываются клиентским React-SPA на Vite, что ухудшает TTFB, SEO и делает локализацию неудобной.
- В рамках этапа «Двуязычие + SSG/SEO» необходимо обеспечить мультиязычную маршрутизацию (uz/ru), автоматическое определение локали, ручной выбор с сохранением в cookie и статическую генерацию наиболее трафиковых страниц.
- Основное приложение (личный кабинет) остаётся SPA на Vite и должно делиться единой сессией по домену obsidian.uz.

## Решение
1. **Публичная витрина → отдельный фронтенд на Next.js (App Router) в каталоге `public-frontend/`.**
   - Используем встроенный i18n router `/[locale]/...`, поддержку SSG/ISR и серверные компоненты для SEO.
   - Next.js разворачивается как отдельный артефакт (статический экспорт + edge/SSR для полу-динамичных страниц) и обслуживает только публичные пути. Vite-SPA остаётся по `/app` (или отдельному поддомену) и переиспользует API.
2. **Схема локалей:**
   - `defaultLocale = uz` (основная аудитория — узбекские пользователи).
   - Доступные локали: `['uz', 'ru']`.
   - Все публичные URL имеют вид `/{locale}/...`. Запрос на корень `/` или без локали получает 302 на выбранную локаль.
   - Приоритет определения локали: `locale` cookie (ручной выбор) → `Accept-Language` (первый визит) → `defaultLocale`.
3. **Определение локали:**
   - На сервере Next.js читаем cookie `obsidian_locale`. Если нет, анализируем заголовок `Accept-Language`, выбираем первую поддерживаемую локаль. Результат сохраняем в cookie (1 год, path=/, SameSite=Lax). Маршрут `/` редиректит на `/{resolvedLocale}`.
   - При смене языка в UI обновляем cookie и делаем навигацию на соответствующий путь.
4. **Slug политика:**
   - Контентные страницы (лендинг, статьи, FAQ) получают локализованные slug-и (`/ru/kak-rabotaet`, `/uz/qanday-ishlaydi`).
   - Динамические сущности пользователя (профили, проекты) сохраняют единую slug-строку пользователя, но локализуют родительские сегменты (`/ru/profiles/{userSlug}` / `/uz/profillar/{userSlug}`).
5. **Редиректы:**
   - Все старые URL без локали получают 301 на новый путь с добавлением `/{defaultLocale}`.
   - При изменении схемы slug-ов конфигурируем `next.config.js` redirects + CDN rules.
6. **SSG/ISR политика:**
   - Полностью статичные страницы (лендинг, escrow, "как работает", маркетплейс-листинг и т.д.) генерируются SSG во время билда.
   - Полу-динамичные страницы (публичные профили, подборки, кейсы) используют ISR с revalidate=60с или on-demand webhook при обновлении данных.

## Последствия
- + Улучшенный SEO/TTFB за счёт SSG и edge кэширования.
- + Простая реализация локализации через встроенную i18n Next.js.
- ± Появляется второй фронтенд-проект (`public-frontend/`) и билд-конвейер, требующий синхронизации релизов.
- − Нужно обеспечить общий стиль/дизайн-компоненты (выделяем shared UI kit пакет в будущем ADR).

