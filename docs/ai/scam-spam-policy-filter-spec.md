# Scam / Spam / Policy Filter Spec

## Назначение
Классификатор анализирует посты, чаты и файлы, чтобы выявлять скам/спам/нарушения политики до того, как они доходят до основной ленты. Вход: текст сообщения, метаданные (линки, вложения, отправитель). Выход: риск-скор, список сработавших правил и рекомендуемое действие.

## Набор признаков
1. **Контакты вне площадки** — регулярки на `@telegram`, `t.me/`, `wa.me/`, номера телефона с призывом «напишите в WhatsApp/Telegram».
2. **Офлайн-переводы** — ключевые фразы «оплата напрямую», «без эскроу», «перевод на карту/crypto». 
3. **Крипто-скам** — слова `USDT`, `airdrop`, `staking`, `double profit`, «инвестиции без риска».
4. **Подозрительные ссылки** — домены из списков блокировок, URL с сокрытием (bit.ly, tinyurl) + нет описания.
5. **Аномальная активность** — >5 одинаковых сообщений за 60 секунд, новый аккаунт без верификации.
6. **Файлы** — вложения с расширениями `.scr`, `.exe`, архивы с паролем.

Каждый сигнал превращается в фичу `{name, weight, snippet}`.

## Правила и пороги действий
| Risk score | Описание | Автодействие |
| --- | --- | --- |
| `>=0.85` | Множественные срабатывания (например, контакт + оффлайн оплата + подозрительная ссылка). | Авто-скрытие поста, создание тикета модерации, уведомление Trust & Safety. |
| `0.60–0.84` | Несколько сильных сигналов или один критический (крипто-скам). | Софт-блок: перевод в очередь модерации, автору показано предупреждение. |
| `0.30–0.59` | Слабые сигналы (повторы, подозрительные слова). | Софт-предупреждение автору, контент остаётся видимым, логируем для обучения. |
| `<0.30` | Низкий риск. | Нет действий, только лог. |

**Цели:** уменьшить скам-публикации на 30% и держать ложные баны (<1% TN → FP).

## Confusion Matrix
- **TP:** подтверждённые скамы, попавшие в `>=0.60`. Ожидаем рост >30% по сравнению с базой.
- **FP:** честные сообщения, ошибочно попавшие в `>=0.60`. Стремимся к <1% от всего честного трафика; отдельно отслеживаем долю аппеляций.
- **FN:** пропущенные скамы (`<0.30`). Эти кейсы анализируются вручную для апдейта правил.
- **TN:** обычные сообщения без флагов, остаются в ленте.
Отчёты строятся по таблице `scam_filter_confusion_daily` с полями `{date, tp, fp, fn, tn, comments}`.

## API контракт (ai-gateway `/scam-filter/score`)
**Request:**
```json
{
  "content_id": "msg-123",
  "content_type": "chat",
  "text": "...",
  "attachments": [{"type": "link", "value": "https://t.me/..."}],
  "metadata": {"author_trust": 0.2, "duplicate_count": 7}
}
```
**Response:**
```json
{
  "content_id": "msg-123",
  "risk_score": 0.91,
  "labels": ["scam", "policy"],
  "detected_signals": [{"type": "off_platform_contact", "weight": 0.4, "snippet": "t.me/..."}],
  "recommended_action": "auto_hide",
  "escalate_to_moderation": true,
  "user_warning": "Сообщение скрыто: запрещены контакты вне платформы.",
  "logging_flags": ["scam_filter.high_risk", "notify.trust_safety"]
}
```

## Логирование и аналитика
- `scam_filter.score_generated` — `{content_id, risk_score, action, signals}`.
- `scam_filter.warning_shown` — `{content_id, user_id, warning_type}`.
- `scam_filter.auto_hide` — `{content_id, moderator_ticket_id}`.
- `scam_filter.feedback` — `{content_id, outcome: tp|fp|fn|tn}` (из ручного ревью).
События стекаются в поток `ai_moderation_events` и используются для расчёта confusion-матрицы.
