# Communications Test Plan

## Объём

Покрываем чат (WS/SSE/поллинг), уведомления, модерацию и споры. План используется на этапах CI, Stage и перед релизом.

## Unit-тесты

| Компонент | Сценарии |
| --- | --- |
| Message state machine | `queued → sent → delivered → read`; отработка ретраев, корректная маркировка системных сообщений. |
| Deduplication notifier | Повторные события пушей/писем агрегируются по `notification_id` (idempotency). Проверка TTL кеша. |
| SLA вычисления | Корректная агрегация `first_response_latency` и `dispute_sla_remaining` для разных часовых поясов. |
| Moderation filters | Регулярные выражения и ML-модели на токсичность: позитивные/негативные кейсы, bypass detection. |
| Attachment validator | MIME detection, лимит размера, вирус-скан (моки). |

## Integration-тесты

| Тема | Сценарии |
| --- | --- |
| Потеря соединения | WS gateway закрывает соединение → клиент автоматически переключается на SSE → сообщения не теряются. |
| Повторная доставка | Worker переотправляет сообщения/уведомления при 5xx API; дедупликация на клиенте и сервере. |
| Вложения | Загрузка больших файлов → генерация временных ссылок, проверка прав доступа. |
| Жалобы/блокировки | Пользователь жалуется на сообщение → создаётся `moderation_case`, сообщение скрывается. |
| Триггеры спора | Нажатие «Открыть спор» в чате → создаётся `dispute`, чат получает системное сообщение, SLA таймер стартует. |
| Нотификации | Email + web push отправляются с корректными шаблонами, ссылки содержат deep-link в чат. |

## E2E

1. **Найм**: клиент создаёт заказ, фрилансер откликается, чат открывается.
2. **Чат**: обмен сообщениями, вложения, подтверждение получения (read receipts).
3. **Сдача работы**: фрилансер прикрепляет файлы, клиент подтверждает и переводит оплату.
4. **Спор**: клиент открывает спор, загружает доказательства, арбитр подключается.
5. **Частичный релиз**: арбитр принимает решение, escrow делится частично.
6. **Закрытие**: спор закрыт, обе стороны получают уведомления, экспорт переписки доступен.
7. **NPS**: после закрытия отправляется опрос, данные попадают в аналитику.

Инструмент: Cypress + mock платежей; тест запускается nightly на Stage.

## Chaos / Reliability

| Тест | Детали |
| --- | --- |
| WS latency injection | Добавляем 500-1500 мс искусственной задержки → проверяем SLA/алерты. |
| WS drop storm | 10% соединений закрываются каждые 30 сек → проверяем backoff, отсутствие DDoS gateway. |
| Message burst | 10k сообщений/мин из одного треда → проверяем квоты и отбрасывание лишних событий. |
| Notification worker restart | Убиваем pod во время массовой рассылки → очередь сообщений не теряется. |
| DB failover | Переключение реплики Postgres → кластер продолжает работать, сообщения ретраятся. |

## Артефакты

- Отчёты unit/integration → CI artifacts (JUnit XML).
- E2E + chaos → выкладываются в `s3://qa-reports/communications/<build>/` с HTML отчётами.
- Непрохождение любого критичного сценария блокирует релиз (см. Stage acceptance чек-лист).
