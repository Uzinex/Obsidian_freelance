# Политика приватности коммуникаций

Документ регламентирует обработку, хранение и удаление данных коммуникаций (чат, модерация, арбитраж) в Obsidian Freelance.

## Хранение переписки

- Сообщения чата хранятся в Postgres (таблица `chat_messages`) и дублируются в S3 для экспорта/архива. Шифрование: Transparent Data Encryption + KMS ключи (rds/obsidian/chat).
- Метаданные (thread_id, contract_id, timestamps, message_kind) доступны для аналитики; содержимое сообщений индексируется в Elastic только после псевдонимизации (см. ниже).
- Доступ ограничен ролями: support, dispute_ops и автоматизированные сервисы. Все действия логируются в `audit_log` (см. `audit-log-runbook.md`).

## Модерация и арбитраж

- Сообщения проходят автоматическую фильтрацию (toxicity, спам) до публикации; модераторы видят только контент, требующий вмешательства.
- В споре арбитры имеют доступ к полной переписке контракта, но только после эскалации `dispute_opened`.
- Переписка в спорах хранится отдельно (`dispute_messages`) и наследует сроки хранения контрактов.

## Маскирование чувствительных данных

- В логах и аналитике запрещено хранить PII/финансовые данные. Перед логированием применяется регекс-маскирование:
  - номера карт/IBAN → `****1234`;
  - e-mail → `u***@domain.com`;
  - телефоны → `+***(***)***-**-**`.
- Маскирование реализуется в middleware `logging/safe_formatter.py` и в ingestion pipeline (Kafka → ClickHouse).
- При экспорте в PostHog свойства `message_preview` и `attachment_name` проходят SHA-256 + salt.

## Ретеншн и удаление по запросу

- Базовый срок хранения переписки — 5 лет после закрытия контракта (регуляторные требования).
- По запросу пользователя (право на удаление, GDPR/CCPA):
  1. Создаётся тикет `privacy_request` и подтверждается владение аккаунтом.
  2. В течение 30 дней выполняется удаление: сообщения помечаются `pending_delete`, затем шифротокен заменяется на `tombstone` и содержимое удаляется из S3.
  3. Модерационные записи и арбитражные решения обезличиваются (оставляем только ID и тип нарушения).
- Для контрактов со спорами удаление возможно только после завершения юридического обязательства (90 дней после закрытия спора). Пользователь информируется о задержке.

## Экспорт переписки по контракту

- Пользователь может запросить экспорт в формате ZIP, содержащий:
  1. `README.txt` — описание, дата формирования, контракт/спор ID.
  2. `messages.csv` — таблица: `message_id, timestamp_iso8601, sender_role, message_kind, text`. Текст очищен от системных тегов.
  3. `attachments/` — файлы (если разрешено контрактом) с именованием `<timestamp>-<message_id>-<original_name>`.
  4. `metadata.json` — hash-суммы файлов, локализация, версии схем.
  5. `dispute/` (опционально) — материалы спора (решения, payout breakdown).
- Все таймштампы — UTC ISO8601, ID сообщений соответствуют БД.
- Экспорт генерируется воркером, подписывается серверным ключом и доступен по временной ссылке (72 часа).
- Перед выдачей экспорт проходит модерацию: запрещённый контент отмечается пометкой `moderation_flag` в `messages.csv`.

## Права субъектов данных

- Пользователь может запросить: доступ к данным, ограничение обработки, исправление информации (например, опечатка в файле).
- Ответ предоставляется в течение 30 дней. Уведомления хранятся в `privacy_requests` и доступны для аудита.

## Совместимость с юридическими требованиями

- Условия арбитража требуют хранение переписки и артефактов спора минимум 5 лет.
- Для регионов с локализацией данных (например, ЕС) реплика переписки хранится в соответствующем регионе (Multi-Region storage, ключи KMS EU).
- Все контроллеры и процессоры указаны в `data-classification.md`.
