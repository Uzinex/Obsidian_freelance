# Email deliverability checklist

Obsidian Freelance отправляет транзакционные письма только по важным событиям (эскалации споров,
финансовые операции, входы в аккаунт). Чтобы сохранить доставляемость и избежать попадания в
спам-папки, придерживаемся следующих требований:

## SPF / DKIM / DMARC

| Запись | Назначение | Требования |
| --- | --- | --- |
| SPF | Разрешает почтовым серверам отправлять письма от имени домена | Публикуем `v=spf1 include:mailgun.org include:_spf.google.com -all` (пример). Обязательно включаем все ESP, которые используем (Mailgun, fallback SMTP). |
| DKIM | Подписывает сообщения, чтобы получатель мог проверить целостность | Создаём выделенный selector `obsidian._domainkey`. Закрытый ключ хранится в Secret Manager, публичный публикуем в DNS. Меняем ключ не реже одного раза в 12 месяцев. |
| DMARC | Политика обработки писем, не прошедших SPF/DKIM | Используем `v=DMARC1; p=quarantine; rua=mailto:dmarc@obsidian.uz; fo=1; pct=100`. На этапе запуска можно оставить `p=none`, но `rua`/`ruf` должны работать. |

## Технические ожидания

- Все письма уходят с домена `notify.obsidian.uz`. PTR-запись сервера совпадает с этим доменом.
- Envelope-from и header-from совпадают, чтобы DMARC не отклонял сообщения.
- Указываем `List-Unsubscribe` заголовок: `List-Unsubscribe: <mailto:unsubscribe@obsidian.uz>` + HTTPS ссылка.
- Добавляем ARC-Seal/ARC-Message-Signature для ретрансляторов (Staff inbox).

## Bounce / complaint handling

1. **Hard bounce** (нет MX, домен не существует): ESP присылает webhook → сохраняем событие в
   `communications_emailbounce` (пока достаточно логировать в Sentry) и ставим флаг `email_hard_bounced_at`
   у пользователя. Повторно отправлять такие письма нельзя без ручного подтверждения.
2. **Soft bounce** (ящик переполнен, временная ошибка): делаем до 3 повторных попыток с интервалами
   5/30/120 минут, затем логируем и переходим в статус `suspended`.
3. **Complaint / spam report**: отписываем пользователя от всех писем, сохраняем дату жалобы. Кроме того,
   блокируем отправку на этот адрес минимум на 30 дней.
4. **Unsubscribe**: храним хеш email+канал, чтобы не отправлять письма даже при импорте контактов.

## Мониторинг

- Уровень жалоб должен быть <0.1%. Настраиваем алерт в ESP.
- DKIM/SPF отчёты проверяются автоматически (DMARC aggregate reports → BigQuery → Looker Studio).
- Если bounce rate >1% в течение часа, cron `run_sla_timers` ставит задачу в PagerDuty для команды
  коммуникаций.
