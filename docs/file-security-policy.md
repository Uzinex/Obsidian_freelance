# Политика безопасности загружаемых файлов

## Общие требования
- Все файлы загружаются через сервис `uploads`, использующий приватное хранилище (`private_media`).
- Прямой доступ из статики запрещён; выдача осуществляется только через подписанные ссылки с ограничением по времени.
- Максимальный размер файла — 20 МБ.
- Разрешённые MIME-типы: `image/jpeg`, `image/png`, `application/pdf`.
- Файлы проверяются по сигнатурам перед сохранением, простая подмена расширения не пройдёт валидацию.
- Для изображений выполняется очистка EXIF-метаданных.

## Антивирус
- Для подключаемого сканера предусмотрен фичефлаг `upload.scanner`.
- При включении фича вызывает интеграционный слой `uploads.scanner.scan_bytes`, который должен быть связан с корпоративным AV.
- Пока интеграция не реализована, включение флага приведёт к ошибке, предотвращая приём непроверенных файлов.

## Presigned URL
- Подписанные ссылки создаются моделью `SecureDocumentLink` и действуют максимум 1 час (настройка в API).
- Ссылки одноразовые и содержат токен, привязанный к документу; истёкшие ссылки автоматически отклоняются.
- Ответ на скачивание выставляет `Content-Disposition: attachment` и `X-Content-Type-Options: nosniff`, исключая исполнение содержимого в браузере.

## KYC
- KYC-документы всегда сохраняются в приватном сегменте и доступны только владельцу, модератору или сотруднику финансов.
- Для загрузки KYC требуется верифицированный профиль и авторизация.

## Аудит и удаление
- Метаданные файла (оригинальное имя, MIME, checksum) сохраняются для аудита.
- Удаление файла через API требует проверки роли и принадлежности документа пользователю.
- Дополнительная ретенция и безвозвратное удаление регламентируются политикой хранения данных (см. secrets_policy.md).
