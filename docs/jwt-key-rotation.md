# Ротация ключей JWT

## Ответственность

- **Владелец процесса:** руководитель платформенной команды (Platform Lead).
- **Исполнители:** DevOps-инженеры Stage/Prod.
- **Ревьюеры безопасности:** Security Officer.

## Хранение ключей

- Ключевые пары (access/refresh) создаются отдельно для Dev, Stage, Prod.
- Каждый ключ хранится в Secret Manager (AWS Secrets Manager/GCP Secret Manager/Hashicorp Vault).
- Секрет содержит:
  - `kid`
  - приватный ключ в PEM
  - публичный ключ в PEM
  - алгоритм (по умолчанию RS256)
- В приложении ключи передаются через переменные окружения `JWT_ACCESS_<ENV>_*`, `JWT_REFRESH_<ENV>_*`.
- Доступ к секретам ограничен по окружениям, минимум два человека с правами на чтение.

## Периодичность

- **Dev:** по требованию, но не реже 90 дней.
- **Stage:** каждые 90 дней либо перед релизом новых алгоритмов.
- **Prod:** каждые 60 дней и при любом подозрении на компрометацию.

## Процедура ротации

1. Сгенерировать новую пару ключей (например, `openssl genrsa -out access.key 4096`).
2. Назначить новый `kid` (UUIDv4) и обновить секрет в Secret Manager.
3. Добавить публичный ключ в переменную `JWT_ACCESS_ADDITIONAL_PUBLIC_KEYS`/`JWT_REFRESH_ADDITIONAL_PUBLIC_KEYS` в формате `kid::public_key`, не удаляя старый `kid`.
4. Обновить переменные окружения с приватными ключами на Stage или Prod.
5. Развернуть приложение. Новые токены подписываются новым ключом, старые проверяются через keyring.
6. После истечения максимального срока жизни refresh-токена (30 дней) удалить старый `kid` из keyring и секретов.
7. Задокументировать ротацию в журнале безопасности (кто, когда, какие `kid`).

## Экстренная ротация

- Немедленно перевыпустить ключи и отключить старый `kid`.
- Инвалидировать все refresh-токены (logout-all).
- Сообщить пользователям о необходимости перелогина.

## Проверка

- После каждого деплоя проверить health-check endpoint `/health` и убедиться, что JWT в ответах подписаны новым `kid`.
- Настроить алерт, если бекенд не может загрузить ключи из ENV.
