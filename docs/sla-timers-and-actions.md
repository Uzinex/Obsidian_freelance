# SLA timers & auto-actions

Все автоматические таймеры крутятся в management-команде `python manage.py run_sla_timers`, которую
запускаем по cron каждые 15 минут (рабочее окно 09:00–18:00 по Ташкенту). Логика вынесена в
`obsidian_backend/sla.py`; каждое действие попадает в `notifications_slaactionlog`.

| Таймер | Условие и порог | Автодействие | Исключения | Учёт рабочего времени |
| --- | --- | --- | --- | --- |
| Нет ответа в чате | Последнее сообщение в `chat_thread` не прочитано и старше 4 часов | `NotificationHub.emit` отправляет напоминание адресату, создаётся `SlaActionLog(rule_code="chat.response")` | Не запускаем повторно для того же `message_id`, не уведомляем если тред заблокирован | Проверяем `_within_working_hours(now)` → напоминания уходят только с 09:00 до 18:00 (Asia/Tashkent) |
| Нет решения по спору | `DisputeCase.sla_due_at` просрочен на 12 часов, статус `opened/evidence/in_review` | Повышаем `priority` до HIGH и уведомляем клиента / lead-модератора (`event_type=contract.dispute_opened`) | Если кейс уже эскалирован (`SlaActionLog` существует) или спор закрыт | Таймер считается в UTC, но эскалации создаём только в рабочие часы; дедлайн переносим на следующий рабочий день, если выпадает на выходные |
| Молчание заказчика | Контракт `status=active`, `updated_at` старше 5 дней, `escrow_release_frozen=False` | Автозавершение `contract.complete()`, выплаты обоим участникам + лента событий | Контракты с флагом `escrow_release_frozen=True`, открытые споры (`contract.dispute_cases.exists()`) | Дни считаются календарно, но `run_sla_timers` делает проверку в рабочие часы; уведомление о завершении указывает длительность «тишины» |
| Bounce rate мониторинг | Bounce rate >1% в час (метрика ESP) | Cron фиксирует событие и создаёт PagerDuty alert (через Sentry) | Нет | Не зависит от рабочего графика, но алерт дублируем в Slack #comm-alerts |

## Рабочие часы (Узбекистан)

- Часовой пояс: `Asia/Tashkent` (UTC+5).
- Рабочие дни: понедельник–пятница. Cron `run_sla_timers` можно запускать в выходные, но
  `_within_working_hours` остановит отправку напоминаний; эскалации и авто-выплаты
  сохраняются в лог и догоняются в понедельник.
- Для расчёта дедлайнов используем календарные дни, но UI показывает метку «перенесено на рабочее
  время», если запуск состоялся ночью/в выходной.
