apiVersion: batch/v1
kind: CronJob
metadata:
  name: db-pitr-backup
spec:
  schedule: "*/5 * * * *"
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: backup-sa
          restartPolicy: OnFailure
          containers:
            - name: wal-g
              image: ghcr.io/wal-g/wal-g:2.0
              env:
                - name: WALG_PGP_KEY
                  valueFrom:
                    secretKeyRef:
                      name: backup-secrets
                      key: pgp-key
                - name: WALG_S3_PREFIX
                  value: s3://obsidian-db-backups/base
                - name: PGHOST
                  value: postgres.primary.svc.cluster.local
                - name: PGPORT
                  value: "5432"
                - name: PGUSER
                  valueFrom:
                    secretKeyRef:
                      name: backup-secrets
                      key: pg-user
                - name: PGPASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: backup-secrets
                      key: pg-password
              command:
                - /bin/sh
                - -c
                - |
                  set -euo pipefail
                  wal-g backup-push /var/lib/postgresql/data
                  wal-g wal-push
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: media-s3-snapshot
spec:
  schedule: "0 2 * * *"
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: backup-sa
          restartPolicy: OnFailure
          containers:
            - name: aws-cli
              image: amazon/aws-cli:2.15.0
              command:
                - /bin/sh
                - -c
                - |
                  set -euo pipefail
                  SNAPSHOT_PREFIX="s3://obsidian-media-snapshots/$(date +%Y/%m/%d)"
                  aws s3 sync s3://obsidian-media/ "$SNAPSHOT_PREFIX" --delete
                  aws s3 ls "$SNAPSHOT_PREFIX"
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: iac-export
spec:
  schedule: "30 1 * * *"
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: backup-sa
          restartPolicy: OnFailure
          containers:
            - name: exporter
              image: alpine/git:2.43.0
              env:
                - name: ARCHIVE_BUCKET
                  value: s3://obsidian-iac-archive
              command:
                - /bin/sh
                - -c
                - |
                  set -euo pipefail
                  git clone --depth=1 https://git.example.com/obsidian/infra.git /tmp/infra
                  tar -C /tmp -czf /tmp/iac.tar.gz infra
                  aws s3 cp /tmp/iac.tar.gz "$ARCHIVE_BUCKET/$(date +%Y-%m-%d)-iac.tar.gz"
